<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hot Wheels – Mi Colección (Optimizado)</title>
<style>
    :root {
      --bg:#f6f8fb;--card:#fff;--primary:#6b7cff;
      --dark:#1f2937;--muted:#6b7280;--radius:18px
    }
    *{box-sizing:border-box;font-family:Inter,system-ui}
    body{margin:0;background:var(--bg);color:var(--dark)}
    .container{max-width:1100px;margin:auto;padding:24px}

    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,#ff6a00,#ff2d55);border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px}
    .btn-primary{background:var(--primary);color:#fff;padding:10px 20px;border-radius:12px;border:none;cursor:pointer;font-weight:bold}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:var(--card);padding:20px;border-radius:var(--radius);text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
    .stat-card h3{margin:0;font-size:14px;color:var(--muted)}
    .stat-card p{margin:10px 0 0;font-size:24px;font-weight:bold}
    
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px}
    .card{background:var(--card);padding:15px;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,0.08);transition:transform 0.2s}
    .card:hover{transform:translateY(-5px)}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:12px;margin-bottom:10px;cursor:pointer}
    .card h4{margin:5px 0;font-size:16px}
    .card-buttons{display:flex;gap:5px;margin-top:10px}
    .btn-action{flex:1;padding:6px;border-radius:8px;border:none;cursor:pointer;font-size:12px;background:#f0f2f5}
    
    #form, #details-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:100}
    .modal-content{background:#fff;width:90%;max-width:500px;margin:40px auto;padding:25px;border-radius:20px;max-height:85vh;overflow-y:auto;position:relative}
    input, select{width:100%;padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:10px;font-size:14px}
    label{font-size:12px;font-weight:bold;color:var(--muted);margin-top:10px;display:block}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:15px">
            <div class="logo">HW</div>
            <div>
                <h1 style="margin:0; font-size:24px">Mi Garaje</h1>
                <span style="color:var(--muted)">Colección Personal</span>
            </div>
        </div>
        <button class="btn-primary" onclick="showForm()">+ Agregar</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><h3>Total</h3><p id="s-total">0</p></div>
        <div class="stat-card"><h3>En Caja</h3><p id="s-inbox">0</p></div>
        <div class="stat-card"><h3>Sueltos</h3><p id="s-nobox">0</p></div>
    </div>

    <div id="content"></div>
</div>

<div id="form">
    <div class="modal-content">
        <h3 id="form-title">Nuevo Hot Wheels</h3>
        <label>Nombre del Modelo</label>
        <input type="text" id="name" placeholder="Ej: '67 Camaro">
        
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>Año</label><input type="number" id="year"></div>
            <div style="flex:1"><label>Nº Colección</label><input type="text" id="hw_number"></div>
        </div>

        <label>Serie / Colección</label>
        <input type="text" id="hw_collection" placeholder="Ej: HW Speed Graphics">
        
        <label>Estado</label>
        <select id="collection_type">
            <option value="in_box">En Caja (Sellado)</option>
            <option value="no_box">Suelto (Sin caja)</option>
            <option value="wishlist">Lista de deseos</option>
        </select>

        <label>Foto del auto</label>
        <input type="file" accept="image/*" onchange="previewImage(this)">
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-primary" style="flex:2" onclick="addCarFromForm()" id="btn-save">Guardar Auto</button>
            <button class="btn-action" style="flex:1" onclick="hideForm()">Cancelar</button>
        </div>
    </div>
</div>

<div id="details-overlay" onclick="hideDetails()"></div>
<div id="details" class="modal-content" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:101;">
    <img id="details-img" src="" style="width:100%; border-radius:15px; max-height:250px; object-fit:contain; background:#eee">
    <h2 id="details-title" style="margin-top:15px"></h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:14px">
        <p><strong>Año:</strong> <span id="details-year"></span></p>
        <p><strong>Número:</strong> <span id="details-hw_number"></span></p>
        <p><strong>Serie:</strong> <span id="details-hw_collection"></span></p>
        <p><strong>Estado:</strong> <span id="details-type"></span></p>
    </div>
    <button onclick="hideDetails()" class="btn-primary" style="width:100%; margin-top:15px">Cerrar</button>
</div>

<script type="module">
import { initializeApp } from "firebase/app";
import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "firebase/firestore";

const firebaseConfig = {
  apiKey: "AIzaSyBVXcElTOWxjmDDupN5iZR9M29ZzlT_w2U",
  authDomain: "hotwheels-coleccion.firebaseapp.com",
  projectId: "hotwheels-coleccion",
  storageBucket: "hotwheels-coleccion.appspot.com",
  messagingSenderId: "498868907702",
  appId: "1:498868907702:web:16d812b8898377f92cc017"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cars = [];
let photoData = '';
let editingCarId = null;

// --- FUNCIÓN PARA COMPRIMIR IMÁGENES (Opción B) ---
function compressImage(base64Str) {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = base64Str;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX_WIDTH = 500; // Tamaño suficiente para ver bien en móvil/web
      let width = img.width;
      let height = img.height;

      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
      }
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/jpeg', 0.6)); // Comprime al 60% de calidad
    };
  });
}

async function loadCars() {
  const querySnapshot = await getDocs(collection(db, 'cars'));
  cars = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  render();
}

async function addCarFromForm() {
  const name = document.getElementById('name').value;
  if(!name) return alert("El nombre es obligatorio");

  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = "Guardando...";

  const carData = {
    name: name,
    year: document.getElementById('year').value,
    hw_collection: document.getElementById('hw_collection').value,
    hw_number: document.getElementById('hw_number').value,
    collection_type: document.getElementById('collection_type').value,
    photo_url: photoData
  };

  try {
    if (editingCarId) {
      await updateDoc(doc(db, 'cars', editingCarId), carData);
    } else {
      await addDoc(collection(db, 'cars'), carData);
    }
    hideForm();
    loadCars(); // Recargar lista
  } catch (e) {
    alert("Error: " + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "Guardar Auto";
  }
}

function render() {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="list">${cars.map(c => `
    <div class="card">
      <img src="${c.photo_url || 'https://via.placeholder.com/200x150?text=Sin+Foto'}" onclick="showCarDetails('${c.id}')">
      <h4>${c.name}</h4>
      <div class="card-buttons">
          <button class="btn-action" onclick="editCar('${c.id}')">Editar</button>
          <button class="btn-action" style="color:#ff4d4d" onclick="deleteCar('${c.id}')">Borrar</button>
      </div>
    </div>
  `).join('')}</div>`;

  document.getElementById('s-total').textContent = cars.length;
  document.getElementById('s-inbox').textContent = cars.filter(c => c.collection_type === 'in_box').length;
  document.getElementById('s-nobox').textContent = cars.filter(c => c.collection_type === 'no_box').length;
}

// EXPOSICIÓN A WINDOW (para usar en HTML)
window.previewImage = async (input) => {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      photoData = await compressImage(e.target.result);
    };
    reader.readAsDataURL(input.files[0]);
  }
};

window.editCar = (id) => {
  const car = cars.find(c => c.id === id);
  editingCarId = id;
  document.getElementById('name').value = car.name;
  document.getElementById('year').value = car.year || '';
  document.getElementById('hw_collection').value = car.hw_collection || '';
  document.getElementById('hw_number').value = car.hw_number || '';
  document.getElementById('collection_type').value = car.collection_type;
  photoData = car.photo_url || '';
  document.getElementById('form-title').textContent = "Editar Auto";
  showForm();
};

window.deleteCar = async (id) => {
  if(confirm('¿Eliminar este auto de la colección?')) {
    await deleteDoc(doc(db, 'cars', id));
    loadCars();
  }
};

window.showCarDetails = (id) => {
  const car = cars.find(c => c.id === id);
  document.getElementById('details-title').textContent = car.name;
  document.getElementById('details-img').src = car.photo_url || 'https://via.placeholder.com/200x150?text=Sin+Foto';
  document.getElementById('details-year').textContent = car.year || '-';
  document.getElementById('details-hw_number').textContent = car.hw_number || '-';
  document.getElementById('details-hw_collection').textContent = car.hw_collection || '-';
  document.getElementById('details-type').textContent = car.collection_type.replace('_', ' ');
  document.getElementById('details-overlay').style.display = 'block';
  document.getElementById('details').style.display = 'block';
};

window.hideDetails = () => {
  document.getElementById('details-overlay').style.display = 'none';
  document.getElementById('details').style.display = 'none';
};

window.showForm = () => { document.getElementById('form').style.display = 'block'; };
window.hideForm = () => { 
    document.getElementById('form').style.display = 'none'; 
    editingCarId = null;
    document.getElementById('name').value = '';
    photoData = '';
};

loadCars();
</script>
</body>
</html>